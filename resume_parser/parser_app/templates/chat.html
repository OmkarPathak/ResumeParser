{% extends 'base.html' %}
{% load static %}

{% block title %}Resume Parser | AI Chat{% endblock %}

{% block content %}
<div class="row justify-content-center" style="margin-top: 2rem;">
    <div class="col-lg-8">
        <div class="card shadow-lg" style="height: 80vh; display: flex; flex-direction: column;">
            <div class="card-header bg-white border-bottom-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="font-weight-bold text-purple">
                        <i class="fas fa-robot mr-2"></i>Chat with Database
                    </h4>
                    <p class="text-muted small mb-0">Ask questions like "Who knows Python?" or "Find 5 years experience"</p>
                </div>
                <button id="new-chat-btn" class="btn btn-outline-danger btn-sm shadow-sm" title="Clear Chat History">
                    <i class="fas fa-trash-alt mr-1"></i> New Chat
                </button>
            </div>
            
            <div class="card-body p-4" id="chat-history" style="flex: 1; overflow-y: auto; background-color: #F8FAFC;">
                <!-- Welcome Message -->
                <div class="chat-message bot-message mb-3">
                    <div class="p-3 rounded-lg bg-white shadow-sm" style="max-width: 80%; border-top-left-radius: 0;">
                        <span class="font-weight-bold text-purple mb-1 d-block"><i class="fas fa-robot mr-1"></i> AI Assistant</span>
                        Hello! I've analyzed all the resumes in your database. How can I help you find the perfect candidate today?
                    </div>
                </div>
            </div>

            <div class="card-footer bg-white border-top p-3">
                <form id="chat-form" class="d-flex">
                    <input type="text" id="user-input" class="form-control form-control-lg mr-2" 
                           placeholder="Type your question..." autocomplete="off">
                    <button type="submit" class="btn btn-purple btn-lg shadow-sm" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --purple: #6f42c1;
        --purple-light: #e0dafd;
    }
    .text-purple { color: var(--purple) !important; }
    .bg-purple { background-color: var(--purple) !important; color: white; }
    .btn-purple { background-color: var(--purple); color: white; border: none; }
    .btn-purple:hover { background-color: #5a32a3; color: white; }
    
    .rounded-lg { border-radius: 0.75rem; }
    .bot-message .p-3 { margin-right: auto; }
    .user-message .p-3 { margin-left: auto; background-color: var(--purple); color: white; border-top-right-radius: 0; }
    
    /* Markdown Styling in Chat */
    .chat-content ul { padding-left: 20px; }
    .chat-content p { margin-bottom: 0.5rem; }
</style>

{% block javascript %}
<script>
    const chatHistory = document.getElementById('chat-history');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const newChatBtn = document.getElementById('new-chat-btn');

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `chat-message ${role}-message mb-3`;
        
        let contentHtml = text;
        // Simple Markdown bold replacement
        contentHtml = contentHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // Replaces [Link Text](URL) with Anchor tags
        // Changed anchor color to be white-ish for user, purple for bot
        const linkColor = role === 'user' ? 'text-white' : 'text-purple';
        contentHtml = contentHtml.replace(/\[(.*?)\]\((.*?)\)/g, `<a href="$2" target="_blank" class="font-weight-bold ${linkColor}" style="text-decoration: underline;">$1 <i class="fas fa-external-link-alt small ml-1"></i></a>`);
        contentHtml = contentHtml.replace(/\n/g, '<br>');

        const bgClass = role === 'user' ? 'bg-purple' : 'bg-white text-dark shadow-sm';
        const alignStyle = role === 'user' ? 'margin-left: auto; border-top-right-radius: 0;' : 'margin-right: auto; border-top-left-radius: 0;';
        const nameColor = role === 'user' ? 'text-white-50' : 'text-purple';
        const name = role === 'user' ? 'You' : 'AI Assistant';

        div.innerHTML = `
            <div class="p-3 rounded-lg ${bgClass} chat-content" style="max-width: 80%; ${alignStyle}">
                <span class="font-weight-bold ${nameColor} mb-1 d-block small">${name === 'AI Assistant' ? '<i class="fas fa-robot mr-1"></i> ' + name : name}</span>
                ${contentHtml}
            </div>
        `;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // New Chat Button Logic
    newChatBtn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to clear the chat history?')) return;

        try {
            const response = await fetch("{% url 'chat_view' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'reset=true'
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                // Clear UI (except welcome message if preferred, or just reload)
                // For simplicity, let's reload the page or clear valid chats
                window.location.reload(); 
            }
        } catch (e) {
            console.error(e);
            alert('Failed to reset chat.');
        }
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = userInput.value.trim();
        if (!query) return;

        // UI Updates
        appendMessage('user', query);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;

        // Loading Indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading';
        loadingDiv.className = 'chat-message bot-message mb-3';
        loadingDiv.innerHTML = `
            <div class="p-3 rounded-lg bg-white shadow-sm" style="max-width: 80%; border-top-left-radius: 0;">
                <span class="text-muted"><i class="fas fa-spinner fa-spin mr-2"></i>Thinking...</span>
            </div>`;
        chatHistory.appendChild(loadingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        try {
            const response = await fetch("{% url 'chat_view' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `query=${encodeURIComponent(query)}`
            });

            const data = await response.json();
            document.getElementById('loading').remove();
            
            if (data.answer) {
                appendMessage('bot', data.answer);
            } else {
                appendMessage('bot', "Sorry, I encountered an error.");
            }

        } catch (error) {
            document.getElementById('loading').remove();
            appendMessage('bot', "Error connecting to the server.");
            console.error(error);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }
    });
</script>
{% endblock %}
{% endblock %}
