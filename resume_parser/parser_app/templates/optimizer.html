{% extends 'base.html' %}
{% load static %}

{% block title %}Resume Parser | Resume Optimizer{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container" style="padding: 1rem 1.5rem; height: calc(100vh - 70px); overflow: hidden;">
    <div class="row h-100">
        <!-- Col 1: Input -->
        <div class="col-lg-3 h-100 mb-2">
            <div class="glass-card h-100 d-flex flex-column">
                <div class="p-3 border-bottom bg-subtle rounded-top">
                    <h6 class="mb-0 text-primary text-uppercase small font-weight-bold">
                        <i class="fas fa-sliders-h mr-2"></i>Configuration
                    </h6>
                </div>
                <div class="p-3 flex-grow-1 d-flex flex-column overflow-hidden">
                    <form method="POST" id="optimize-form" class="h-100 d-flex flex-column">
                        {% csrf_token %}
                        
                        <div class="form-group mb-3">
                            <label class="small font-weight-bold text-muted text-uppercase mb-2">Target Profile</label>
                            <select name="resume_id" class="form-control" required>
                                <option value="" disabled selected>Select Resume...</option>
                                {% for resume in resumes %}
                                    <option value="{{ resume.id }}" {% if selected_resume_id == resume.id %}selected{% endif %}>
                                        {{ resume.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group mb-3 flex-grow-1 d-flex flex-column" style="height: 60vh;">
                            <label class="small font-weight-bold text-muted text-uppercase mb-2">Job Requirement</label>
                            <textarea name="job_description" class="form-control flex-grow-1" 
                                      style="font-size: 0.9rem; height: 60vh;" 
                                      placeholder="Paste the full Job Description here..." required>{{ job_description }}</textarea>
                        </div>

                        <button type="submit" id="optimize-btn" class="btn btn-primary w-100 mt-2">
                            <span id="btn-text"><i class="fas fa-bolt mr-2"></i>Analyze</span>
                            <span id="btn-loader" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Processing...</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {% if results %}
        <!-- Col 2: Metrics -->
        <div class="col-lg-5 h-100 mb-2 d-flex flex-column">
            <!-- Match Score Section -->
            <div class="card mb-3 flex-shrink-0 border-0 shadow-md" style="min-height: 220px; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);">
                <div class="card-body d-flex align-items-center justify-content-between p-4">
                    <div style="flex: 1; margin-right: 1.5rem;">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge badge-pill badge-primary-soft text-uppercase">Match Score</span>
                        </div>
                        <h1 class="mb-2 display-4 text-gradient" style="line-height: 1;">{{ results.match_score }}%</h1>
                        <p class="text-secondary mb-0" style="font-size: 0.95rem;">
                            {% if results.score_reasoning %}
                                {{ results.score_reasoning }}
                            {% else %}
                                Alignment based on skills, experience, and education metadata.
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <div style="position: relative; width: 130px; height: 130px;">
                            <svg width="130" height="130" viewBox="0 0 130 130" style="filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.2));">
                                <circle cx="65" cy="65" r="58" fill="none" stroke="#e2e8f0" stroke-width="10"/>
                                <circle class="score-progress" cx="65" cy="65" r="58" fill="none" stroke="url(#primaryGradient)" stroke-width="10"
                                        stroke-dasharray="364.42" stroke-dashoffset="364.42" stroke-linecap="round" transform="rotate(-90 65 65)"/>
                                <defs>
                                    <linearGradient id="primaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#6366f1"/>
                                        <stop offset="100%" stop-color="#8b5cf6"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <i class="fas fa-bullseye fa-2x text-muted" style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gap Analysis Section -->
            <div class="glass-card flex-grow-1 d-flex flex-column overflow-hidden">
                <div class="p-3 border-bottom bg-subtle rounded-top">
                    <h6 class="mb-0 text-success text-uppercase small font-weight-bold">
                        <i class="fas fa-chart-pie mr-2"></i>Gap Analysis
                    </h6>
                </div>
                <div class="p-3 overflow-auto" style="scrollbar-width: thin;">
                    <div class="mb-4">
                        <label class="small font-weight-bold text-muted text-uppercase mb-3">Match Highlights</label>
                        {% if results.strengths %}
                            {% for strength in results.strengths %}
                                <div class="alert alert-light border d-flex align-items-center py-2 px-3 mb-2 rounded shadow-sm">
                                    <i class="fas fa-check-circle text-success mr-3"></i>
                                    <span class="font-weight-600 text-dark" style="font-size: 0.9rem;">{{ strength }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="small text-muted font-italic">No specific strengths detected.</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="small font-weight-bold text-muted text-uppercase mb-3">Critical Gaps</label>
                        {% if results.gaps %}
                            {% for gap in results.gaps %}
                                <div class="alert alert-light border d-flex align-items-center py-2 px-3 mb-2 rounded shadow-sm">
                                    <i class="fas fa-exclamation-triangle text-danger mr-3"></i>
                                    <span class="font-weight-600 text-dark" style="font-size: 0.9rem;">{{ gap }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="small text-muted font-italic">No critical gaps found!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Col 3: Strategy -->
        <div class="col-lg-4 h-100 mb-2">
             <div class="glass-card h-100 d-flex flex-column">
                <div class="p-3 border-bottom bg-subtle rounded-top">
                    <h6 class="mb-0 text-warning text-uppercase small font-weight-bold">
                        <i class="fas fa-road mr-2"></i>Roadmap
                    </h6>
                </div>
                <div class="p-3 overflow-auto" style="scrollbar-width: thin;">
                    {% if results.action_items %}
                        <div class="mb-4">
                            <label class="small font-weight-bold text-dark mb-3">High Priority Actions</label>
                            {% for item in results.action_items %}
                                <div class="d-flex align-items-start mb-3 p-3 border rounded bg-white shadow-sm">
                                    <div class="mr-3">
                                        <span class="badge badge-warning text-white rounded-circle p-2" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">{{ forloop.counter }}</span>
                                    </div>
                                    <div class="text-secondary font-weight-600" style="font-size: 0.9rem;">{{ item }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if results.suggestions %}
                        <div>
                            <label class="small font-weight-bold text-primary mb-3">Editorial Suggestions</label>
                            {% for suggestion in results.suggestions %}
                                <div class="d-flex mb-3 p-3 border rounded bg-white shadow-sm">
                                    <div class="mr-3 text-primary">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <div class="text-secondary font-weight-600" style="font-size: 0.9rem;">{{ suggestion }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
             </div>
        </div>
        
        {% else %}
        <!-- Empty State in Col 2+3 -->
        <div class="col-lg-9 h-100">
            <div class="glass-card h-100 d-flex align-items-center justify-content-center">
                <div class="text-center p-5">
                    <div class="mb-4 text-muted" style="font-size: 4rem; opacity: 0.2;">
                        <i class="fas fa-dna"></i>
                    </div>
                    <h3 class="font-weight-bold text-dark mb-3">AI Optimization Engine</h3>
                    <p class="text-secondary lead px-lg-5" style="max-width: 600px; margin: 0 auto;">Select a resume and paste the job description configurations on the left to begin the deep alignment analysis.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.getElementById('optimize-form').addEventListener('submit', function() {
        const btn = document.getElementById('optimize-btn');
        btn.classList.add('disabled');
        btn.style.opacity = '0.8';
        document.getElementById('btn-text').style.display = 'none';
        document.getElementById('btn-loader').style.display = 'inline-block';
    });

    // Animate score
    window.addEventListener('load', () => {
        const progress = document.querySelector('.score-progress');
        if (progress) {
            const score = parseInt("{{ results.match_score|default:0 }}");
            const circumference = 364.42; 
            const offset = circumference - (score / 100) * circumference;
            setTimeout(() => {
                progress.style.transition = 'stroke-dashoffset 1.5s cubic-bezier(0.22, 1, 0.36, 1)';
                progress.style.strokeDashoffset = offset;
            }, 300);
        }
    });
</script>
{% endblock %}
