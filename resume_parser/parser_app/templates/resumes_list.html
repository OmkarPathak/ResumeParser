{% extends 'base.html' %}
{% load static %}

{% block title %}Resume List{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-4">
    <!-- Header Section -->
    <div class="d-flex align-items-center justify-content-between mb-4 fade-in">
        <div>
            <h2 class="h2 font-weight-bold mb-1">Candidate Database</h2>
            <p class="text-secondary small mb-0">Manage and analyze processed resumes.</p>
        </div>
        <div>
            <a href="{% url 'candidates:upload_candidate' %}" class="btn btn-primary shadow-sm">
                <i class="fas fa-plus mr-2"></i>Upload New
            </a>
            <a href="{% url 'export_resumes' %}?{{ request.GET.urlencode }}" class="btn btn-secondary shadow-sm ml-2">
                <i class="fas fa-file-export mr-2"></i>Export CSV
            </a>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card border-0 mb-4 fade-in">
        <div class="card-body py-3">
            <form method="GET" action="." class="mb-0">
                <div class="row align-items-end">
                    <div class="col-md-3 mb-2 mb-md-0">
                        <label class="font-weight-600 text-uppercase small text-muted mb-2">Search</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white border-right-0"><i class="fas fa-search text-muted"></i></span>
                            </div>
                            <input type="text" name="q" class="form-control filter-control border-left-0 pl-0" placeholder="Name, Email, Skills..." value="{{ search_query|default:'' }}">
                        </div>
                    </div>
                    <div class="col-md-3 mb-2 mb-md-0">
                        <label class="font-weight-600 text-uppercase small text-muted mb-2">Filter by Tag</label>
                        <select name="tag" class="form-select filter-control">
                            <option value="">All Tags</option>
                            {% for tag in tags %}
                            <option value="{{ tag }}" {% if selected_tag == tag %}selected{% endif %}>{{ tag }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-2 mb-md-0">
                        <label class="font-weight-600 text-uppercase small text-muted mb-2">Rows</label>
                        <select name="per_page" class="form-select filter-control" onchange="this.form.submit()">
                            <option value="10" {% if request.GET.per_page == '10' %}selected{% endif %}>10</option>
                            <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50</option>
                            <option value="all" {% if request.GET.per_page == 'all' %}selected{% endif %}>All</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-md-right">
                        <div class="d-flex align-items-center justify-content-end">
                            <div class="btn-group mr-2">
                                <button type="button" class="btn btn-sm view-toggle-btn active" id="btn-view-card" onclick="switchView('card')" title="Card View">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button type="button" class="btn btn-sm view-toggle-btn" id="btn-view-table" onclick="switchView('table')" title="Table View">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary px-3 shadow-sm mr-2">
                                Apply
                            </button>
                            <a href="{% url 'resumes_list' %}" class="btn btn-sm btn-light border px-3 shadow-sm mr-2">
                                Clear
                            </a>
                            <button type="submit" class="btn btn-sm btn-danger px-3 shadow-sm" form="bulk-delete-form" onclick="return confirm('Delete selected?')" id="bulk-delete-btn" disabled>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Cards Grid & Table View -->
    <form method="POST" action="{% url 'delete_bulk_resumes' %}" id="bulk-delete-form">
        {% csrf_token %}
        
        <!-- Card View Container -->
        <div id="view-card">
            <div class="d-flex align-items-center mb-3 ml-1">
                <div class="custom-control custom-checkbox pl-0">
                    <input type="checkbox" class="custom-control-input" id="select-all-cards">
                    <label class="custom-control-label font-weight-bold text-secondary user-select-none pl-4" for="select-all-cards" style="padding-top: 2px;">Select All</label>
                </div>
                <span class="ml-3 text-muted small selection-count"></span>
            </div>

            <div class="row">
                {% for resume in resumes %}
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 p-3 d-flex flex-column hover-shadow-lg">
                        <!-- Card Top: Checkbox & Actions -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" name="bulk_delete" value="{{ resume.id }}" class="custom-control-input resume-checkbox card-checkbox" id="resume_card_{{ resume.id }}">
                                <label class="custom-control-label" for="resume_card_{{ resume.id }}"></label>
                            </div>
                            <div class="action-btn-group">
                                <a href="{% url 'view_resume' resume.id %}" class="btn btn-sm text-info bg-light" title="View PDF">
                                    <i class="fas fa-eye fa-sm"></i>
                                </a>
                                <a href="{% url 'update_resume' resume.id %}" class="btn btn-sm text-primary bg-light" title="Edit">
                                    <i class="fas fa-pen fa-sm"></i>
                                </a>
                                <button type="button" class="btn btn-sm text-danger bg-light" 
                                   onclick="confirmDelete('{{ resume.id }}')" title="Delete">
                                    <i class="fas fa-trash fa-sm"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex align-items-center mb-4">
                            <div class="avatar-placeholder mr-3 flex-shrink-0">
                                {{ resume.name|slice:":1"|upper }}
                            </div>
                            <div style="min-width: 0;">
                                <div class="d-flex align-items-center mb-1">
                                    <h5 class="font-weight-bold text-dark mb-0 text-truncate" title="{{ resume.name }}">{{ resume.name }}</h5>
                                    {% if resume.tag %}
                                    <span class="badge badge-modern badge-light text-primary border border-light ml-2">{{ resume.tag }}</span>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted text-truncate">{{ resume.uploaded_on|date:"M d, Y" }}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Card Body: Details -->
                        <div class="mb-3">
                            <div class="info-row" title="{{ resume.email }}">
                                <i class="fas fa-envelope"></i>
                                <span class="text-truncate">{{ resume.email }}</span>
                            </div>
                            <div class="info-row" title="{{ resume.mobile_number }}">
                                <i class="fas fa-phone"></i>
                                <span class="text-truncate">{{ resume.mobile_number }}</span>
                            </div>
                        </div>

                        <!-- AI Preview Section -->
                        <div class="mt-auto">
                            {% if resume.ai_summary %}
                            <div class="small font-weight-bold text-primary mb-1">
                                <i class="fas fa-magic mr-1"></i> AI Summary
                            </div>
                            <div class="summary-preview mb-3">
                                {{ resume.ai_summary|truncatewords:8 }}
                                <a href="javascript:void(0);" 
                                   onclick="openSummaryModal('{{ resume.id }}', '{{ resume.name|escapejs }}')"
                                   class="text-primary font-weight-bold ml-1" style="font-size: 0.85rem; text-decoration: none;">
                                   Read more
                                </a>
                            </div>
                            {% endif %}

                            <div class="d-flex justify-content-between align-items-center">
                                <div class="metric-badge">
                                    <i class="fas fa-clock mr-1" style="color: #4e73df;"></i>
                                    {% if resume.processing_time %}{{ resume.processing_time }}s{% else %}N/A{% endif %}
                                </div>
                                {% if resume.remark and resume.remark != 'None' %}
                                <div class="metric-badge" title="{{ resume.remark }}" style="max-width: 140px;">
                                    <span class="text-truncate">{{ resume.remark }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Table View Container -->
        <div id="view-table" style="display: none;">
            <div class="card shadow-sm border-0" style="border-radius: 16px; overflow: hidden;">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary">
                            <tr>
                                <th class="border-top-0 border-bottom-0" style="width: 40px;">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="select-all-table">
                                        <label class="custom-control-label" for="select-all-table"></label>
                                    </div>
                                </th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Name</th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Tag</th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Contact</th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;"><i class="fas fa-magic mr-1"></i> AI Summary</th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Metrics</th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Skills</th>
                                <th class="border-top-0 border-bottom-0 font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Date</th>
                                <th class="border-top-0 border-bottom-0 text-right font-weight-bold small text-uppercase" style="letter-spacing: 1px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for resume in resumes %}
                            <tr>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" name="bulk_delete" value="{{ resume.id }}" class="custom-control-input resume-checkbox table-checkbox" id="resume_table_{{ resume.id }}">
                                        <label class="custom-control-label" for="resume_table_{{ resume.id }}"></label>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-placeholder mr-3" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                            {{ resume.name|slice:":1"|upper }}
                                        </div>
                                        <span class="font-weight-bold text-dark">{{ resume.name }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if resume.tag %}
                                        <span class="badge badge-modern badge-light text-primary border border-light">{{ resume.tag }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ resume.email }}</td>
                                <td>{{ resume.mobile_number }}</td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ resume.education }}">
                                        {{ resume.education|default:"-" }}
                                    </span>
                                </td>
                                <td>
                                    {% if resume.skills %}
                                        <span class="badge badge-primary-soft">{{ resume.skills|length }} Skills</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><small class="text-muted">{{ resume.uploaded_on|date:"M d, Y" }}</small></td>
                                <td class="text-right">
                                    <div class="d-flex justify-content-end">
                                        <a href="{% url 'view_resume' resume.id %}" class="btn btn-sm btn-icon-only text-info bg-light mr-1" title="View PDF">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'update_resume' resume.id %}" class="btn btn-sm btn-icon-only text-primary bg-light mr-1" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-icon-only text-danger bg-light" onclick="confirmDelete('{{ resume.id }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="d-flex justify-content-end mt-2">
                <span class="text-muted small selection-count"></span>
            </div>
        </div>

    </form>
    




    <!-- Pagination -->
    {% if resumes.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-5 mb-5">
        <ul class="pagination justify-content-center">
            {% if resumes.has_previous %}
            <li class="page-item">
                <a class="page-link border-0 shadow-sm rounded-circle m-1 bg-white text-primary" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
                    href="?page={{ resumes.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}"
                    aria-label="Previous">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for i in resumes.paginator.page_range %}
            {% if resumes.number == i %}
            <li class="page-item active"><span class="page-link border-0 shadow-lg rounded-circle m-1 bg-primary text-white font-weight-bold" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">{{ i }}</span></li>
            {% else %}
            <li class="page-item">
                <a class="page-link border-0 shadow-sm rounded-circle m-1 bg-white text-secondary" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
                    href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}">
                    {{ i }}
                </a>
            </li>
            {% endif %}
            {% endfor %}

            {% if resumes.has_next %}
            <li class="page-item">
                <a class="page-link border-0 shadow-sm rounded-circle m-1 bg-white text-primary" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
                    href="?page={{ resumes.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}"
                    aria-label="Next">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Shared Hidden Content for Modals -->
{% for resume in resumes %}
    {% if resume.ai_summary %}
    <div id="summary-content-{{ resume.id }}" class="d-none">{{ resume.ai_summary }}</div>
    <div id="strengths-content-{{ resume.id }}" class="d-none">{{ resume.ai_strengths|default:'' }}</div>
    {% endif %}
{% endfor %}

<!-- Summary Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-bottom-0 bg-light" style="border-radius: 20px 20px 0 0;">
                <h5 class="modal-title font-weight-bold text-dark" id="summaryModalLabel"><i class="fas fa-robot mr-2"></i> AI Analysis</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <h6 class="text-uppercase text-primary font-weight-bold small mb-3" style="letter-spacing: 1px;"><i class="fas fa-magic mr-1"></i> AI Professional Summary</h6>
                <div class="bg-light p-4 rounded-lg mb-4">
                    <p id="modal-summary-text" class="text-dark mb-0" style="white-space: pre-wrap; line-height: 1.6;"></p>
                </div>
                
                <div id="modal-strengths-section" style="display: none;">
                    <h6 class="text-uppercase text-success font-weight-bold small mb-3" style="letter-spacing: 1px;"><i class="fas fa-star-of-life mr-1"></i> AI Key Strengths</h6>
                    <div class="bg-soft-success p-4 rounded-lg">
                        <p id="modal-strengths-text" class="text-dark mb-0" style="white-space: pre-wrap; line-height: 1.6;"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0 bg-light" style="border-radius: 0 0 20px 20px;">
                <button type="button" class="btn btn-secondary px-4 rounded-pill" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <span class="fa-stack fa-2x text-danger animate__animated animate__pulse">
                        <i class="fas fa-circle fa-stack-2x" style="opacity: 0.2;"></i>
                        <i class="fas fa-trash-alt fa-stack-1x"></i>
                    </span>
                </div>
                <h5 class="font-weight-bold text-dark mb-2">Delete Candidate?</h5>
                <p class="text-muted mb-4">This action is <strong>irreversible</strong>. The candidate profile and all related data will be permanently removed.</p>
                
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-2" data-dismiss="modal">Cancel</button>
                    <a href="#" id="confirm-delete-btn" class="btn btn-danger rounded-pill px-4 shadow-sm">
                        Delete Permanently
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    // View Switching Logic
    function switchView(view) {
        if (view === 'table') {
            $('#view-card').hide();
            $('#view-table').fadeIn(200);
            $('#btn-view-card').removeClass('active');
            $('#btn-view-table').addClass('active');
            localStorage.setItem('resume_list_view', 'table');
        } else {
            $('#view-table').hide();
            $('#view-card').fadeIn(200);
            $('#btn-view-table').removeClass('active');
            $('#btn-view-card').addClass('active');
            localStorage.setItem('resume_list_view', 'card');
        }
    }

    // Initialize
    $(document).ready(function() {
        // Restore saved view
        const savedView = localStorage.getItem('resume_list_view');
        if (savedView === 'table') {
            switchView('table');
        } else {
            // Default to card view
            switchView('card');
        }

        // Activate Tooltips
        $('[data-toggle="tooltip"]').tooltip();
    });

    // Summary Modal Logic
    function openSummaryModal(id, name) {
        var summaryText = document.getElementById('summary-content-' + id).innerText;
        var strengthsText = document.getElementById('strengths-content-' + id).innerText;
        
        $('#summaryModalLabel').text('AI Analysis: ' + name);
        $('#modal-summary-text').text(summaryText);
        
        if (strengthsText && strengthsText.trim() !== '') {
            $('#modal-strengths-section').show();
            
            // Try to parse the python list string style: ['Skill 1', 'Skill 2']
            let formattedHtml = '';
            try {
                // simple cleanup to make it JSON compatible (replace single quotes with double, handle escaped quotes if any)
                let jsonStr = strengthsText.replace(/'/g, '"');
                let skills = JSON.parse(jsonStr);
                
                if (Array.isArray(skills)) {
                    formattedHtml = '<ul class="pl-3 mb-0" style="list-style-type: disc;">';
                    skills.forEach(skill => {
                         formattedHtml += `<li class="mb-1">${skill}</li>`;
                    });
                    formattedHtml += '</ul>';
                } else {
                     formattedHtml = strengthsText;
                }
            } catch (e) {
                // Fallback if parsing fails
                formattedHtml = strengthsText;
            }
            
            $('#modal-strengths-text').html(formattedHtml);
        } else {
            $('#modal-strengths-section').hide();
        }
        
        $('#summaryModal').modal('show');
    }

    // Confirm Delete Logic
    function confirmDelete(id) {
        // Hardcoded URL to avoid reversal issues in JS
        var url = "/candidates/" + id + "/delete/";
        $('#confirm-delete-btn').attr('href', url);
        $('#deleteModal').modal('show');
    }

    // Checkbox Synchronization Logic
    
    // Sync "Select All" checkboxes
    $('#select-all-cards').change(function() {
        const checked = $(this).is(':checked');
        $('#select-all-table').prop('checked', checked);
        $('.resume-checkbox').prop('checked', checked);
        toggleDeleteBtn();
        updateSelectionCount();
    });

    $('#select-all-table').change(function() {
        const checked = $(this).is(':checked');
        $('#select-all-cards').prop('checked', checked);
        $('.resume-checkbox').prop('checked', checked);
        toggleDeleteBtn();
        updateSelectionCount();
    });

    // Sync Individual Checkboxes
    $(document).on('change', '.resume-checkbox', function() {
        const id = $(this).val();
        const checked = $(this).is(':checked');
        
        // Update the counterpart checkbox (e.g. if card clicked, update table)
        // identifying by value since they share the resume.id
        $(`.resume-checkbox[value="${id}"]`).prop('checked', checked);
        
        // Update Select All state if not all are checked
        if (!checked) {
            $('#select-all-cards, #select-all-table').prop('checked', false);
        }
        
        toggleDeleteBtn();
        updateSelectionCount();
    });

    function toggleDeleteBtn() {
        // Count unique selected IDs (since we have duplicates in DOM)
        const selectedIds = new Set();
        $('.resume-checkbox:checked').each(function() {
            selectedIds.add($(this).val());
        });
        
        const count = selectedIds.size;
        document.getElementById('bulk-delete-btn').disabled = count === 0;
    }

    function updateSelectionCount() {
        const selectedIds = new Set();
        $('.resume-checkbox:checked').each(function() {
            selectedIds.add($(this).val());
        });
        
        const count = selectedIds.size;
        const text = count > 0 ? count + ' selected' : '';
        
        $('.selection-count').text(text);
    }
</script>
{% endblock %}
